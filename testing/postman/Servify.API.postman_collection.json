{
  "info": {
    "_postman_id": "d7bb4fd7-11e0-4b4b-9221-3137eca5aa5d",
    "name": "Servify API Automation",
    "description": "Credential-based Postman/Newman automation for Servify API with role-sync refresh and DB snapshot checks for users/categories/services/bookings.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "Smoke",
      "item": [
        {
          "name": "Init Dynamic Data (Bootstrap)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/categories/"
          },
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const isInitRequest = pm.info.requestName === 'Init Dynamic Data (Bootstrap)';",
                  "if (isInitRequest || !pm.collectionVariables.get('runId')) {",
                  "  const runId = String(Date.now());",
                  "  pm.collectionVariables.set('runId', runId);",
                  "  pm.collectionVariables.set('categoryOneName', 'Cleaning ' + runId);",
                  "  pm.collectionVariables.set('categoryTwoName', 'Plumbing ' + runId);",
                  "  pm.collectionVariables.set('serviceOneTitle', 'Home Cleaning ' + runId);",
                  "  pm.collectionVariables.set('serviceTwoTitle', 'Pipe Repair ' + runId);",
                  "  pm.collectionVariables.set('nonExistentBookingId', '00000000-0000-0000-0000-000000000000');",
                  "}"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Initialization request completed', function () {",
                  "  pm.expect([200, 500]).to.include(pm.response.code);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Admin Login",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/auth/login",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{adminEmail}}\",\n  \"password\": \"{{adminPassword}}\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const decodeJwtPayload = (token) => {",
                  "  if (!token || token.split('.').length !== 3) return null;",
                  "  const base64Url = token.split('.')[1];",
                  "  const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');",
                  "  const jsonPayload = decodeURIComponent(",
                  "    atob(base64)",
                  "      .split('')",
                  "      .map((c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))",
                  "      .join('')",
                  "  );",
                  "  return JSON.parse(jsonPayload);",
                  "};",
                  "",
                  "",
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Admin login returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "pm.expect(json && json.accessToken, 'Expected accessToken').to.be.a('string');",
                  "pm.collectionVariables.set('adminAccessToken', json.accessToken);",
                  "",
                  "const payload = decodeJwtPayload(json.accessToken);",
                  "if (payload && payload.role) pm.collectionVariables.set('adminTokenRole', payload.role);",
                  "if (payload && payload.id) pm.collectionVariables.set('adminUserId', payload.id);"
                ]
              }
            }
          ]
        },
        {
          "name": "Provider Login",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/auth/login",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{providerEmail}}\",\n  \"password\": \"{{providerPassword}}\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const decodeJwtPayload = (token) => {",
                  "  if (!token || token.split('.').length !== 3) return null;",
                  "  const base64Url = token.split('.')[1];",
                  "  const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');",
                  "  const jsonPayload = decodeURIComponent(",
                  "    atob(base64)",
                  "      .split('')",
                  "      .map((c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))",
                  "      .join('')",
                  "  );",
                  "  return JSON.parse(jsonPayload);",
                  "};",
                  "",
                  "",
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Provider login returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "pm.expect(json && json.accessToken, 'Expected accessToken').to.be.a('string');",
                  "pm.collectionVariables.set('providerAccessToken', json.accessToken);",
                  "",
                  "const payload = decodeJwtPayload(json.accessToken);",
                  "if (payload && payload.role) pm.collectionVariables.set('providerTokenRole', payload.role);",
                  "if (payload && payload.id) pm.collectionVariables.set('providerUserId', payload.id);"
                ]
              }
            }
          ]
        },
        {
          "name": "Provider Profile Snapshot",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{providerAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/users/profile"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Provider profile returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "pm.expect(json && json.id, 'Expected provider id').to.be.a('string');",
                  "pm.collectionVariables.set('providerUserId', String(json.id));",
                  "pm.collectionVariables.set('providerUserType', String(json.user_type || ''));"
                ]
              }
            }
          ]
        },
        {
          "name": "Promote Provider If Needed",
          "request": {
            "method": "PATCH",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{providerAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/users/promote",
            "body": {
              "mode": "raw",
              "raw": "{}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const decodeJwtPayload = (token) => {",
                  "  if (!token || token.split('.').length !== 3) return null;",
                  "  const base64Url = token.split('.')[1];",
                  "  const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');",
                  "  const jsonPayload = decodeURIComponent(",
                  "    atob(base64)",
                  "      .split('')",
                  "      .map((c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))",
                  "      .join('')",
                  "  );",
                  "  return JSON.parse(jsonPayload);",
                  "};",
                  "",
                  "",
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Promote endpoint returns expected status', function () {",
                  "  pm.expect([200, 400, 403]).to.include(pm.response.code);",
                  "});",
                  "",
                  "if (pm.response.code === 200) {",
                  "  const json = parseJsonSafe();",
                  "  if (json && json.accessToken) {",
                  "    pm.collectionVariables.set('providerAccessToken', json.accessToken);",
                  "    const payload = decodeJwtPayload(json.accessToken);",
                  "    if (payload && payload.role) pm.collectionVariables.set('providerTokenRole', payload.role);",
                  "  }",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "Provider Refresh Token Role Sync",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/auth/refresh",
            "body": {
              "mode": "raw",
              "raw": "{}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const decodeJwtPayload = (token) => {",
                  "  if (!token || token.split('.').length !== 3) return null;",
                  "  const base64Url = token.split('.')[1];",
                  "  const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');",
                  "  const jsonPayload = decodeURIComponent(",
                  "    atob(base64)",
                  "      .split('')",
                  "      .map((c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))",
                  "      .join('')",
                  "  );",
                  "  return JSON.parse(jsonPayload);",
                  "};",
                  "",
                  "",
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Provider refresh returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "pm.expect(json && json.accessToken, 'Expected refreshed accessToken').to.be.a('string');",
                  "pm.collectionVariables.set('providerAccessToken', json.accessToken);",
                  "",
                  "const payload = decodeJwtPayload(json.accessToken);",
                  "pm.expect(payload && payload.role, 'Expected role claim').to.be.a('string');",
                  "pm.collectionVariables.set('providerTokenRole', payload.role);",
                  "pm.test('Refreshed provider token has provider role', function () {",
                  "  pm.expect(payload.role).to.eql('provider');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Provider Profile After Role Sync",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{providerAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/users/profile"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Provider profile after sync returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "pm.expect(json && json.id, 'Expected provider id').to.be.a('string');",
                  "pm.collectionVariables.set('providerUserId', String(json.id));",
                  "pm.collectionVariables.set('providerUserType', String(json.user_type || ''));",
                  "pm.test('Provider profile reports provider role', function () {",
                  "  pm.expect(String(json.user_type || '')).to.eql('provider');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Client Login",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/auth/login",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{clientEmail}}\",\n  \"password\": \"{{clientPassword}}\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const decodeJwtPayload = (token) => {",
                  "  if (!token || token.split('.').length !== 3) return null;",
                  "  const base64Url = token.split('.')[1];",
                  "  const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');",
                  "  const jsonPayload = decodeURIComponent(",
                  "    atob(base64)",
                  "      .split('')",
                  "      .map((c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))",
                  "      .join('')",
                  "  );",
                  "  return JSON.parse(jsonPayload);",
                  "};",
                  "",
                  "",
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Client login returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "pm.expect(json && json.accessToken, 'Expected accessToken').to.be.a('string');",
                  "pm.collectionVariables.set('clientAccessToken', json.accessToken);",
                  "",
                  "const payload = decodeJwtPayload(json.accessToken);",
                  "if (payload && payload.role) pm.collectionVariables.set('clientTokenRole', payload.role);",
                  "if (payload && payload.id) pm.collectionVariables.set('clientUserId', payload.id);"
                ]
              }
            }
          ]
        },
        {
          "name": "Client Profile Snapshot",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{clientAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/users/profile"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Client profile returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "pm.expect(json && json.id, 'Expected client id').to.be.a('string');",
                  "pm.collectionVariables.set('clientUserId', String(json.id));",
                  "pm.collectionVariables.set('clientUserType', String(json.user_type || ''));"
                ]
              }
            }
          ]
        },
        {
          "name": "DB Snapshot Users (Admin)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{adminAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/users/"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Admin list users returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "const users = asArray(json, 'users');",
                  "pm.expect(users, 'Expected users array').to.be.an('array');",
                  "pm.collectionVariables.set('usersCount', String(users.length));"
                ]
              }
            }
          ]
        },
        {
          "name": "DB Snapshot Categories (Public)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/categories/"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Public categories returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "const categories = asArray(json, 'categories');",
                  "pm.expect(categories, 'Expected categories array').to.be.an('array');",
                  "pm.collectionVariables.set('categoriesCount', String(categories.length));",
                  "",
                  "const runId = pm.collectionVariables.get('runId');",
                  "const nameOne = 'Cleaning ' + runId;",
                  "const nameTwo = 'Plumbing ' + runId;",
                  "",
                  "const existingOne = categories.find((c) => c && c.name === nameOne);",
                  "const existingTwo = categories.find((c) => c && c.name === nameTwo);",
                  "",
                  "if (!pm.collectionVariables.get('categoryOneId')) {",
                  "  if (existingOne && existingOne.id !== undefined) {",
                  "    pm.collectionVariables.set('categoryOneId', String(existingOne.id));",
                  "  } else if (categories[0] && categories[0].id !== undefined) {",
                  "    pm.collectionVariables.set('categoryOneId', String(categories[0].id));",
                  "  }",
                  "}",
                  "",
                  "if (!pm.collectionVariables.get('categoryTwoId')) {",
                  "  if (existingTwo && existingTwo.id !== undefined) {",
                  "    pm.collectionVariables.set('categoryTwoId', String(existingTwo.id));",
                  "  } else if (categories[1] && categories[1].id !== undefined) {",
                  "    pm.collectionVariables.set('categoryTwoId', String(categories[1].id));",
                  "  } else if (pm.collectionVariables.get('categoryOneId')) {",
                  "    pm.collectionVariables.set('categoryTwoId', String(pm.collectionVariables.get('categoryOneId')));",
                  "  }",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "Admin Create Category 1",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{adminAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/categories/",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"{{categoryOneName}}\",\n  \"description\": \"Automation test category: cleaning services\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Create category 1 returns 201', function () {",
                  "  pm.response.to.have.status(201);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "const category = asEntity(json, 'category');",
                  "const id = getId(category);",
                  "pm.expect(id, 'Expected category id').to.not.eql('');",
                  "pm.collectionVariables.set('categoryOneId', id);"
                ]
              }
            }
          ]
        },
        {
          "name": "DB Snapshot Categories (Public)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/categories/"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Public categories returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "const categories = asArray(json, 'categories');",
                  "pm.expect(categories, 'Expected categories array').to.be.an('array');",
                  "pm.collectionVariables.set('categoriesCount', String(categories.length));",
                  "",
                  "const runId = pm.collectionVariables.get('runId');",
                  "const nameOne = 'Cleaning ' + runId;",
                  "const nameTwo = 'Plumbing ' + runId;",
                  "",
                  "const existingOne = categories.find((c) => c && c.name === nameOne);",
                  "const existingTwo = categories.find((c) => c && c.name === nameTwo);",
                  "",
                  "if (!pm.collectionVariables.get('categoryOneId')) {",
                  "  if (existingOne && existingOne.id !== undefined) {",
                  "    pm.collectionVariables.set('categoryOneId', String(existingOne.id));",
                  "  } else if (categories[0] && categories[0].id !== undefined) {",
                  "    pm.collectionVariables.set('categoryOneId', String(categories[0].id));",
                  "  }",
                  "}",
                  "",
                  "if (!pm.collectionVariables.get('categoryTwoId')) {",
                  "  if (existingTwo && existingTwo.id !== undefined) {",
                  "    pm.collectionVariables.set('categoryTwoId', String(existingTwo.id));",
                  "  } else if (categories[1] && categories[1].id !== undefined) {",
                  "    pm.collectionVariables.set('categoryTwoId', String(categories[1].id));",
                  "  } else if (pm.collectionVariables.get('categoryOneId')) {",
                  "    pm.collectionVariables.set('categoryTwoId', String(pm.collectionVariables.get('categoryOneId')));",
                  "  }",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "Provider Create Service 1",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{providerAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/services/create",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"category_id\": \"{{categoryOneId}}\",\n  \"title\": \"{{serviceOneTitle}}\",\n  \"description\": \"Full apartment deep cleaning\",\n  \"price\": 1500,\n  \"service_type\": \"onsite\",\n  \"location\": \"Makati, Metro Manila\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "if (!pm.collectionVariables.get('categoryOneId') && pm.collectionVariables.get('categoryTwoId')) {",
                  "  pm.collectionVariables.set('categoryOneId', pm.collectionVariables.get('categoryTwoId'));",
                  "}"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Create service 1 returns 201', function () {",
                  "  pm.response.to.have.status(201);",
                  "});",
                  "const json = parseJsonSafe();",
                  "const service = asEntity(json);",
                  "const id = getId(service);",
                  "pm.expect(id, 'Expected service id').to.not.eql('');",
                  "pm.collectionVariables.set('serviceId', id);"
                ]
              }
            }
          ]
        },
        {
          "name": "DB Snapshot Services (Client)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{clientAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/services/"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Get all services returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "const services = asArray(json, 'services');",
                  "pm.expect(services, 'Expected services array').to.be.an('array');",
                  "pm.collectionVariables.set('servicesCount', String(services.length));",
                  "",
                  "const runId = pm.collectionVariables.get('runId');",
                  "const nameOne = 'Home Cleaning ' + runId;",
                  "const nameTwo = 'Pipe Repair ' + runId;",
                  "",
                  "const foundOne = services.find((s) => s && s.title === nameOne) || services[0];",
                  "const foundTwo = services.find((s) => s && s.title === nameTwo) || services[1] || foundOne;",
                  "",
                  "if (foundOne && foundOne.id) pm.collectionVariables.set('serviceId', String(foundOne.id));",
                  "if (foundTwo && foundTwo.id) pm.collectionVariables.set('serviceTwoId', String(foundTwo.id));"
                ]
              }
            }
          ]
        },
        {
          "name": "Client Create Booking",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{clientAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/bookings/createBooking",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"service_id\": \"{{serviceId}}\",\n  \"client_id\": \"{{clientUserId}}\",\n  \"provider_id\": \"{{providerUserId}}\",\n  \"booking_date\": \"2026-03-15\",\n  \"booking_time\": \"14:00\",\n  \"user_location\": \"123 Main St, Makati City\",\n  \"total_price\": 1500,\n  \"notes\": \"Please bring cleaning supplies\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const deps = ['serviceId', 'clientUserId', 'providerUserId'];",
                  "const missing = deps.filter((k) => !pm.collectionVariables.get(k));",
                  "if (missing.length) {",
                  "  throw new Error('Missing booking dependencies: ' + missing.join(', '));",
                  "}"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Create booking returns 201', function () {",
                  "  pm.response.to.have.status(201);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "const booking = asEntity(json);",
                  "const id = getId(booking);",
                  "pm.expect(id, 'Expected booking id').to.not.eql('');",
                  "pm.collectionVariables.set('bookingId', id);"
                ]
              }
            }
          ]
        },
        {
          "name": "DB Snapshot Bookings (Client)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{clientAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/bookings/client/{{clientUserId}}"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Get client bookings returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "const bookings = asArray(json, 'bookings');",
                  "pm.expect(bookings, 'Expected bookings array').to.be.an('array');",
                  "pm.collectionVariables.set('clientBookingsCount', String(bookings.length));",
                  "",
                  "const serviceId = String(pm.collectionVariables.get('serviceId') || '');",
                  "const matched = bookings.find((b) => b && String(b.service_id || '') === serviceId) || bookings[0];",
                  "if (matched && matched.id) pm.collectionVariables.set('bookingId', String(matched.id));",
                  "pm.expect(pm.collectionVariables.get('bookingId'), 'Expected bookingId after bookings snapshot').to.be.a('string');"
                ]
              }
            }
          ]
        },
        {
          "name": "Provider Login For Token Lifecycle",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/auth/login",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{providerEmail}}\",\n  \"password\": \"{{providerPassword}}\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Provider login for token lifecycle returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "const json = parseJsonSafe();",
                  "pm.expect(json && json.accessToken).to.be.a('string');",
                  "pm.collectionVariables.set('providerAccessToken', json.accessToken);"
                ]
              }
            }
          ]
        },
        {
          "name": "Provider Refresh Access Token",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/auth/refresh",
            "body": {
              "mode": "raw",
              "raw": "{}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Refresh token returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "const json = parseJsonSafe();",
                  "pm.expect(json && json.accessToken, 'Expected refreshed accessToken').to.be.a('string');",
                  "pm.collectionVariables.set('providerAccessToken', json.accessToken);"
                ]
              }
            }
          ]
        },
        {
          "name": "Provider Logout",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/auth/logout",
            "body": {
              "mode": "raw",
              "raw": "{}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Logout returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Provider Refresh After Logout",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/auth/refresh",
            "body": {
              "mode": "raw",
              "raw": "{}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Refresh after logout is denied', function () {",
                  "  pm.expect([401, 403]).to.include(pm.response.code);",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "E2E Flow",
      "item": [
        {
          "name": "Init Dynamic Data (Bootstrap)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/categories/"
          },
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const isInitRequest = pm.info.requestName === 'Init Dynamic Data (Bootstrap)';",
                  "if (isInitRequest || !pm.collectionVariables.get('runId')) {",
                  "  const runId = String(Date.now());",
                  "  pm.collectionVariables.set('runId', runId);",
                  "  pm.collectionVariables.set('categoryOneName', 'Cleaning ' + runId);",
                  "  pm.collectionVariables.set('categoryTwoName', 'Plumbing ' + runId);",
                  "  pm.collectionVariables.set('serviceOneTitle', 'Home Cleaning ' + runId);",
                  "  pm.collectionVariables.set('serviceTwoTitle', 'Pipe Repair ' + runId);",
                  "  pm.collectionVariables.set('nonExistentBookingId', '00000000-0000-0000-0000-000000000000');",
                  "}"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Initialization request completed', function () {",
                  "  pm.expect([200, 500]).to.include(pm.response.code);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Admin Login",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/auth/login",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{adminEmail}}\",\n  \"password\": \"{{adminPassword}}\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const decodeJwtPayload = (token) => {",
                  "  if (!token || token.split('.').length !== 3) return null;",
                  "  const base64Url = token.split('.')[1];",
                  "  const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');",
                  "  const jsonPayload = decodeURIComponent(",
                  "    atob(base64)",
                  "      .split('')",
                  "      .map((c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))",
                  "      .join('')",
                  "  );",
                  "  return JSON.parse(jsonPayload);",
                  "};",
                  "",
                  "",
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Admin login returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "pm.expect(json && json.accessToken, 'Expected accessToken').to.be.a('string');",
                  "pm.collectionVariables.set('adminAccessToken', json.accessToken);",
                  "",
                  "const payload = decodeJwtPayload(json.accessToken);",
                  "if (payload && payload.role) pm.collectionVariables.set('adminTokenRole', payload.role);",
                  "if (payload && payload.id) pm.collectionVariables.set('adminUserId', payload.id);"
                ]
              }
            }
          ]
        },
        {
          "name": "DB Snapshot Users (Admin)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{adminAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/users/"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Admin list users returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "const users = asArray(json, 'users');",
                  "pm.expect(users, 'Expected users array').to.be.an('array');",
                  "pm.collectionVariables.set('usersCount', String(users.length));"
                ]
              }
            }
          ]
        },
        {
          "name": "Provider Login",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/auth/login",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{providerEmail}}\",\n  \"password\": \"{{providerPassword}}\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const decodeJwtPayload = (token) => {",
                  "  if (!token || token.split('.').length !== 3) return null;",
                  "  const base64Url = token.split('.')[1];",
                  "  const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');",
                  "  const jsonPayload = decodeURIComponent(",
                  "    atob(base64)",
                  "      .split('')",
                  "      .map((c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))",
                  "      .join('')",
                  "  );",
                  "  return JSON.parse(jsonPayload);",
                  "};",
                  "",
                  "",
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Provider login returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "pm.expect(json && json.accessToken, 'Expected accessToken').to.be.a('string');",
                  "pm.collectionVariables.set('providerAccessToken', json.accessToken);",
                  "",
                  "const payload = decodeJwtPayload(json.accessToken);",
                  "if (payload && payload.role) pm.collectionVariables.set('providerTokenRole', payload.role);",
                  "if (payload && payload.id) pm.collectionVariables.set('providerUserId', payload.id);"
                ]
              }
            }
          ]
        },
        {
          "name": "Provider Profile Snapshot",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{providerAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/users/profile"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Provider profile returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "pm.expect(json && json.id, 'Expected provider id').to.be.a('string');",
                  "pm.collectionVariables.set('providerUserId', String(json.id));",
                  "pm.collectionVariables.set('providerUserType', String(json.user_type || ''));"
                ]
              }
            }
          ]
        },
        {
          "name": "Promote Provider If Needed",
          "request": {
            "method": "PATCH",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{providerAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/users/promote",
            "body": {
              "mode": "raw",
              "raw": "{}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const decodeJwtPayload = (token) => {",
                  "  if (!token || token.split('.').length !== 3) return null;",
                  "  const base64Url = token.split('.')[1];",
                  "  const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');",
                  "  const jsonPayload = decodeURIComponent(",
                  "    atob(base64)",
                  "      .split('')",
                  "      .map((c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))",
                  "      .join('')",
                  "  );",
                  "  return JSON.parse(jsonPayload);",
                  "};",
                  "",
                  "",
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Promote endpoint returns expected status', function () {",
                  "  pm.expect([200, 400, 403]).to.include(pm.response.code);",
                  "});",
                  "",
                  "if (pm.response.code === 200) {",
                  "  const json = parseJsonSafe();",
                  "  if (json && json.accessToken) {",
                  "    pm.collectionVariables.set('providerAccessToken', json.accessToken);",
                  "    const payload = decodeJwtPayload(json.accessToken);",
                  "    if (payload && payload.role) pm.collectionVariables.set('providerTokenRole', payload.role);",
                  "  }",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "Provider Refresh Token Role Sync",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/auth/refresh",
            "body": {
              "mode": "raw",
              "raw": "{}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const decodeJwtPayload = (token) => {",
                  "  if (!token || token.split('.').length !== 3) return null;",
                  "  const base64Url = token.split('.')[1];",
                  "  const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');",
                  "  const jsonPayload = decodeURIComponent(",
                  "    atob(base64)",
                  "      .split('')",
                  "      .map((c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))",
                  "      .join('')",
                  "  );",
                  "  return JSON.parse(jsonPayload);",
                  "};",
                  "",
                  "",
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Provider refresh returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "pm.expect(json && json.accessToken, 'Expected refreshed accessToken').to.be.a('string');",
                  "pm.collectionVariables.set('providerAccessToken', json.accessToken);",
                  "",
                  "const payload = decodeJwtPayload(json.accessToken);",
                  "pm.expect(payload && payload.role, 'Expected role claim').to.be.a('string');",
                  "pm.collectionVariables.set('providerTokenRole', payload.role);",
                  "pm.test('Refreshed provider token has provider role', function () {",
                  "  pm.expect(payload.role).to.eql('provider');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Provider Profile After Role Sync",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{providerAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/users/profile"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Provider profile after sync returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "pm.expect(json && json.id, 'Expected provider id').to.be.a('string');",
                  "pm.collectionVariables.set('providerUserId', String(json.id));",
                  "pm.collectionVariables.set('providerUserType', String(json.user_type || ''));",
                  "pm.test('Provider profile reports provider role', function () {",
                  "  pm.expect(String(json.user_type || '')).to.eql('provider');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Client Login",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/auth/login",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{clientEmail}}\",\n  \"password\": \"{{clientPassword}}\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const decodeJwtPayload = (token) => {",
                  "  if (!token || token.split('.').length !== 3) return null;",
                  "  const base64Url = token.split('.')[1];",
                  "  const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');",
                  "  const jsonPayload = decodeURIComponent(",
                  "    atob(base64)",
                  "      .split('')",
                  "      .map((c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))",
                  "      .join('')",
                  "  );",
                  "  return JSON.parse(jsonPayload);",
                  "};",
                  "",
                  "",
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Client login returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "pm.expect(json && json.accessToken, 'Expected accessToken').to.be.a('string');",
                  "pm.collectionVariables.set('clientAccessToken', json.accessToken);",
                  "",
                  "const payload = decodeJwtPayload(json.accessToken);",
                  "if (payload && payload.role) pm.collectionVariables.set('clientTokenRole', payload.role);",
                  "if (payload && payload.id) pm.collectionVariables.set('clientUserId', payload.id);"
                ]
              }
            }
          ]
        },
        {
          "name": "Client Profile Snapshot",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{clientAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/users/profile"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Client profile returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "pm.expect(json && json.id, 'Expected client id').to.be.a('string');",
                  "pm.collectionVariables.set('clientUserId', String(json.id));",
                  "pm.collectionVariables.set('clientUserType', String(json.user_type || ''));"
                ]
              }
            }
          ]
        },
        {
          "name": "Client List Users Forbidden",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{clientAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/users/"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Client list users returns 403', function () {",
                  "  pm.response.to.have.status(403);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "DB Snapshot Categories (Public)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/categories/"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Public categories returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "const categories = asArray(json, 'categories');",
                  "pm.expect(categories, 'Expected categories array').to.be.an('array');",
                  "pm.collectionVariables.set('categoriesCount', String(categories.length));",
                  "",
                  "const runId = pm.collectionVariables.get('runId');",
                  "const nameOne = 'Cleaning ' + runId;",
                  "const nameTwo = 'Plumbing ' + runId;",
                  "",
                  "const existingOne = categories.find((c) => c && c.name === nameOne);",
                  "const existingTwo = categories.find((c) => c && c.name === nameTwo);",
                  "",
                  "if (!pm.collectionVariables.get('categoryOneId')) {",
                  "  if (existingOne && existingOne.id !== undefined) {",
                  "    pm.collectionVariables.set('categoryOneId', String(existingOne.id));",
                  "  } else if (categories[0] && categories[0].id !== undefined) {",
                  "    pm.collectionVariables.set('categoryOneId', String(categories[0].id));",
                  "  }",
                  "}",
                  "",
                  "if (!pm.collectionVariables.get('categoryTwoId')) {",
                  "  if (existingTwo && existingTwo.id !== undefined) {",
                  "    pm.collectionVariables.set('categoryTwoId', String(existingTwo.id));",
                  "  } else if (categories[1] && categories[1].id !== undefined) {",
                  "    pm.collectionVariables.set('categoryTwoId', String(categories[1].id));",
                  "  } else if (pm.collectionVariables.get('categoryOneId')) {",
                  "    pm.collectionVariables.set('categoryTwoId', String(pm.collectionVariables.get('categoryOneId')));",
                  "  }",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "Admin Create Category 1",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{adminAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/categories/",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"{{categoryOneName}}\",\n  \"description\": \"Automation test category: cleaning services\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Create category 1 returns 201', function () {",
                  "  pm.response.to.have.status(201);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "const category = asEntity(json, 'category');",
                  "const id = getId(category);",
                  "pm.expect(id, 'Expected category id').to.not.eql('');",
                  "pm.collectionVariables.set('categoryOneId', id);"
                ]
              }
            }
          ]
        },
        {
          "name": "Admin Create Category 2",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{adminAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/categories/",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"{{categoryTwoName}}\",\n  \"description\": \"Automation test category: plumbing services\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Create category 2 returns 201', function () {",
                  "  pm.response.to.have.status(201);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "const category = asEntity(json, 'category');",
                  "const id = getId(category);",
                  "pm.expect(id, 'Expected category id').to.not.eql('');",
                  "pm.collectionVariables.set('categoryTwoId', id);"
                ]
              }
            }
          ]
        },
        {
          "name": "DB Snapshot Categories (Public)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/categories/"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Public categories returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "const categories = asArray(json, 'categories');",
                  "pm.expect(categories, 'Expected categories array').to.be.an('array');",
                  "pm.collectionVariables.set('categoriesCount', String(categories.length));",
                  "",
                  "const runId = pm.collectionVariables.get('runId');",
                  "const nameOne = 'Cleaning ' + runId;",
                  "const nameTwo = 'Plumbing ' + runId;",
                  "",
                  "const existingOne = categories.find((c) => c && c.name === nameOne);",
                  "const existingTwo = categories.find((c) => c && c.name === nameTwo);",
                  "",
                  "if (!pm.collectionVariables.get('categoryOneId')) {",
                  "  if (existingOne && existingOne.id !== undefined) {",
                  "    pm.collectionVariables.set('categoryOneId', String(existingOne.id));",
                  "  } else if (categories[0] && categories[0].id !== undefined) {",
                  "    pm.collectionVariables.set('categoryOneId', String(categories[0].id));",
                  "  }",
                  "}",
                  "",
                  "if (!pm.collectionVariables.get('categoryTwoId')) {",
                  "  if (existingTwo && existingTwo.id !== undefined) {",
                  "    pm.collectionVariables.set('categoryTwoId', String(existingTwo.id));",
                  "  } else if (categories[1] && categories[1].id !== undefined) {",
                  "    pm.collectionVariables.set('categoryTwoId', String(categories[1].id));",
                  "  } else if (pm.collectionVariables.get('categoryOneId')) {",
                  "    pm.collectionVariables.set('categoryTwoId', String(pm.collectionVariables.get('categoryOneId')));",
                  "  }",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "Public Get Category By ID",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/categories/{{categoryOneId}}"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Get category by id returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Provider Create Service 1",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{providerAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/services/create",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"category_id\": \"{{categoryOneId}}\",\n  \"title\": \"{{serviceOneTitle}}\",\n  \"description\": \"Full apartment deep cleaning\",\n  \"price\": 1500,\n  \"service_type\": \"onsite\",\n  \"location\": \"Makati, Metro Manila\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "if (!pm.collectionVariables.get('categoryOneId') && pm.collectionVariables.get('categoryTwoId')) {",
                  "  pm.collectionVariables.set('categoryOneId', pm.collectionVariables.get('categoryTwoId'));",
                  "}"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Create service 1 returns 201', function () {",
                  "  pm.response.to.have.status(201);",
                  "});",
                  "const json = parseJsonSafe();",
                  "const service = asEntity(json);",
                  "const id = getId(service);",
                  "pm.expect(id, 'Expected service id').to.not.eql('');",
                  "pm.collectionVariables.set('serviceId', id);"
                ]
              }
            }
          ]
        },
        {
          "name": "Provider Create Service 2",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{providerAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/services/create",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"category_id\": \"{{categoryTwoId}}\",\n  \"title\": \"{{serviceTwoTitle}}\",\n  \"description\": \"Leak and pipe repair\",\n  \"price\": 1200,\n  \"service_type\": \"onsite\",\n  \"location\": \"Taguig, Metro Manila\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "if (!pm.collectionVariables.get('categoryTwoId') && pm.collectionVariables.get('categoryOneId')) {",
                  "  pm.collectionVariables.set('categoryTwoId', pm.collectionVariables.get('categoryOneId'));",
                  "}"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Create service 2 returns 201', function () {",
                  "  pm.response.to.have.status(201);",
                  "});",
                  "const json = parseJsonSafe();",
                  "const service = asEntity(json);",
                  "const id = getId(service);",
                  "pm.expect(id, 'Expected service id').to.not.eql('');",
                  "pm.collectionVariables.set('serviceTwoId', id);"
                ]
              }
            }
          ]
        },
        {
          "name": "DB Snapshot Services (Client)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{clientAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/services/"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Get all services returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "const services = asArray(json, 'services');",
                  "pm.expect(services, 'Expected services array').to.be.an('array');",
                  "pm.collectionVariables.set('servicesCount', String(services.length));",
                  "",
                  "const runId = pm.collectionVariables.get('runId');",
                  "const nameOne = 'Home Cleaning ' + runId;",
                  "const nameTwo = 'Pipe Repair ' + runId;",
                  "",
                  "const foundOne = services.find((s) => s && s.title === nameOne) || services[0];",
                  "const foundTwo = services.find((s) => s && s.title === nameTwo) || services[1] || foundOne;",
                  "",
                  "if (foundOne && foundOne.id) pm.collectionVariables.set('serviceId', String(foundOne.id));",
                  "if (foundTwo && foundTwo.id) pm.collectionVariables.set('serviceTwoId', String(foundTwo.id));"
                ]
              }
            }
          ]
        },
        {
          "name": "Client Get Service By ID",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{clientAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/services/{{serviceId}}"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Get service by id returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "const service = asEntity(json);",
                  "pm.expect(getId(service), 'Expected service id').to.eql(String(pm.collectionVariables.get('serviceId') || ''));"
                ]
              }
            }
          ]
        },
        {
          "name": "Provider Edit Service 1",
          "request": {
            "method": "PUT",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{providerAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/services/edit/{{serviceId}}",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"title\": \"Premium {{serviceOneTitle}}\",\n  \"description\": \"Updated deep cleaning service\",\n  \"price\": 2000,\n  \"service_type\": \"onsite\",\n  \"location\": \"BGC, Taguig\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Edit service returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Client Create Booking",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{clientAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/bookings/createBooking",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"service_id\": \"{{serviceId}}\",\n  \"client_id\": \"{{clientUserId}}\",\n  \"provider_id\": \"{{providerUserId}}\",\n  \"booking_date\": \"2026-03-15\",\n  \"booking_time\": \"14:00\",\n  \"user_location\": \"123 Main St, Makati City\",\n  \"total_price\": 1500,\n  \"notes\": \"Please bring cleaning supplies\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const deps = ['serviceId', 'clientUserId', 'providerUserId'];",
                  "const missing = deps.filter((k) => !pm.collectionVariables.get(k));",
                  "if (missing.length) {",
                  "  throw new Error('Missing booking dependencies: ' + missing.join(', '));",
                  "}"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Create booking returns 201', function () {",
                  "  pm.response.to.have.status(201);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "const booking = asEntity(json);",
                  "const id = getId(booking);",
                  "pm.expect(id, 'Expected booking id').to.not.eql('');",
                  "pm.collectionVariables.set('bookingId', id);"
                ]
              }
            }
          ]
        },
        {
          "name": "DB Snapshot Bookings (Client)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{clientAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/bookings/client/{{clientUserId}}"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Get client bookings returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "const bookings = asArray(json, 'bookings');",
                  "pm.expect(bookings, 'Expected bookings array').to.be.an('array');",
                  "pm.collectionVariables.set('clientBookingsCount', String(bookings.length));",
                  "",
                  "const serviceId = String(pm.collectionVariables.get('serviceId') || '');",
                  "const matched = bookings.find((b) => b && String(b.service_id || '') === serviceId) || bookings[0];",
                  "if (matched && matched.id) pm.collectionVariables.set('bookingId', String(matched.id));",
                  "pm.expect(pm.collectionVariables.get('bookingId'), 'Expected bookingId after bookings snapshot').to.be.a('string');"
                ]
              }
            }
          ]
        },
        {
          "name": "Client Get All Bookings",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{clientAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/bookings/"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Get all bookings returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "const json = parseJsonSafe();",
                  "const bookings = asArray(json, 'bookings');",
                  "pm.expect(bookings).to.be.an('array');",
                  "pm.collectionVariables.set('allBookingsCount', String(bookings.length));"
                ]
              }
            }
          ]
        },
        {
          "name": "Provider Get Incoming Bookings",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{providerAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/bookings/provider/{{providerUserId}}"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Get provider bookings returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Provider Accept Booking",
          "request": {
            "method": "PATCH",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{providerAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/bookings/{{bookingId}}/status",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"status\": \"accepted\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Accept booking returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Provider Complete Booking",
          "request": {
            "method": "PATCH",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{providerAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/bookings/{{bookingId}}/status",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"status\": \"completed\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Complete booking returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Provider Login For Token Lifecycle",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/auth/login",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{providerEmail}}\",\n  \"password\": \"{{providerPassword}}\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Provider login for token lifecycle returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "const json = parseJsonSafe();",
                  "pm.expect(json && json.accessToken).to.be.a('string');",
                  "pm.collectionVariables.set('providerAccessToken', json.accessToken);"
                ]
              }
            }
          ]
        },
        {
          "name": "Provider Refresh Access Token",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/auth/refresh",
            "body": {
              "mode": "raw",
              "raw": "{}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Refresh token returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "const json = parseJsonSafe();",
                  "pm.expect(json && json.accessToken, 'Expected refreshed accessToken').to.be.a('string');",
                  "pm.collectionVariables.set('providerAccessToken', json.accessToken);"
                ]
              }
            }
          ]
        },
        {
          "name": "Provider Logout",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/auth/logout",
            "body": {
              "mode": "raw",
              "raw": "{}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Logout returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Provider Refresh After Logout",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/auth/refresh",
            "body": {
              "mode": "raw",
              "raw": "{}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Refresh after logout is denied', function () {",
                  "  pm.expect([401, 403]).to.include(pm.response.code);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Client Login",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/auth/login",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{clientEmail}}\",\n  \"password\": \"{{clientPassword}}\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const decodeJwtPayload = (token) => {",
                  "  if (!token || token.split('.').length !== 3) return null;",
                  "  const base64Url = token.split('.')[1];",
                  "  const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');",
                  "  const jsonPayload = decodeURIComponent(",
                  "    atob(base64)",
                  "      .split('')",
                  "      .map((c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))",
                  "      .join('')",
                  "  );",
                  "  return JSON.parse(jsonPayload);",
                  "};",
                  "",
                  "",
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Client login returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "pm.expect(json && json.accessToken, 'Expected accessToken').to.be.a('string');",
                  "pm.collectionVariables.set('clientAccessToken', json.accessToken);",
                  "",
                  "const payload = decodeJwtPayload(json.accessToken);",
                  "if (payload && payload.role) pm.collectionVariables.set('clientTokenRole', payload.role);",
                  "if (payload && payload.id) pm.collectionVariables.set('clientUserId', payload.id);"
                ]
              }
            }
          ]
        },
        {
          "name": "Delete Booking",
          "request": {
            "method": "DELETE",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{clientAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/bookings/{{bookingId}}"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Delete booking returns 200 or 404', function () {",
                  "  pm.expect([200, 404]).to.include(pm.response.code);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Provider Login",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/auth/login",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{providerEmail}}\",\n  \"password\": \"{{providerPassword}}\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const decodeJwtPayload = (token) => {",
                  "  if (!token || token.split('.').length !== 3) return null;",
                  "  const base64Url = token.split('.')[1];",
                  "  const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');",
                  "  const jsonPayload = decodeURIComponent(",
                  "    atob(base64)",
                  "      .split('')",
                  "      .map((c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))",
                  "      .join('')",
                  "  );",
                  "  return JSON.parse(jsonPayload);",
                  "};",
                  "",
                  "",
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Provider login returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "pm.expect(json && json.accessToken, 'Expected accessToken').to.be.a('string');",
                  "pm.collectionVariables.set('providerAccessToken', json.accessToken);",
                  "",
                  "const payload = decodeJwtPayload(json.accessToken);",
                  "if (payload && payload.role) pm.collectionVariables.set('providerTokenRole', payload.role);",
                  "if (payload && payload.id) pm.collectionVariables.set('providerUserId', payload.id);"
                ]
              }
            }
          ]
        },
        {
          "name": "Provider Refresh Token Role Sync",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/auth/refresh",
            "body": {
              "mode": "raw",
              "raw": "{}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const decodeJwtPayload = (token) => {",
                  "  if (!token || token.split('.').length !== 3) return null;",
                  "  const base64Url = token.split('.')[1];",
                  "  const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');",
                  "  const jsonPayload = decodeURIComponent(",
                  "    atob(base64)",
                  "      .split('')",
                  "      .map((c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))",
                  "      .join('')",
                  "  );",
                  "  return JSON.parse(jsonPayload);",
                  "};",
                  "",
                  "",
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Provider refresh returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "pm.expect(json && json.accessToken, 'Expected refreshed accessToken').to.be.a('string');",
                  "pm.collectionVariables.set('providerAccessToken', json.accessToken);",
                  "",
                  "const payload = decodeJwtPayload(json.accessToken);",
                  "pm.expect(payload && payload.role, 'Expected role claim').to.be.a('string');",
                  "pm.collectionVariables.set('providerTokenRole', payload.role);",
                  "pm.test('Refreshed provider token has provider role', function () {",
                  "  pm.expect(payload.role).to.eql('provider');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Provider Delete Service 1",
          "request": {
            "method": "DELETE",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{providerAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/services/{{serviceId}}"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Delete service 1 returns 200 or 404', function () {",
                  "  pm.expect([200, 404]).to.include(pm.response.code);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Provider Delete Service 2",
          "request": {
            "method": "DELETE",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{providerAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/services/{{serviceTwoId}}"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Delete service 2 returns 200 or 404', function () {",
                  "  pm.expect([200, 404]).to.include(pm.response.code);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Admin Login",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/auth/login",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{adminEmail}}\",\n  \"password\": \"{{adminPassword}}\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const decodeJwtPayload = (token) => {",
                  "  if (!token || token.split('.').length !== 3) return null;",
                  "  const base64Url = token.split('.')[1];",
                  "  const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');",
                  "  const jsonPayload = decodeURIComponent(",
                  "    atob(base64)",
                  "      .split('')",
                  "      .map((c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))",
                  "      .join('')",
                  "  );",
                  "  return JSON.parse(jsonPayload);",
                  "};",
                  "",
                  "",
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Admin login returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "pm.expect(json && json.accessToken, 'Expected accessToken').to.be.a('string');",
                  "pm.collectionVariables.set('adminAccessToken', json.accessToken);",
                  "",
                  "const payload = decodeJwtPayload(json.accessToken);",
                  "if (payload && payload.role) pm.collectionVariables.set('adminTokenRole', payload.role);",
                  "if (payload && payload.id) pm.collectionVariables.set('adminUserId', payload.id);"
                ]
              }
            }
          ]
        },
        {
          "name": "Admin Delete Category 1",
          "request": {
            "method": "DELETE",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{adminAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/categories/{{categoryOneId}}"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Delete category 1 returns 200 or 404', function () {",
                  "  pm.expect([200, 404]).to.include(pm.response.code);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Admin Delete Category 2",
          "request": {
            "method": "DELETE",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{adminAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/categories/{{categoryTwoId}}"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Delete category 2 returns 200 or 404', function () {",
                  "  pm.expect([200, 404]).to.include(pm.response.code);",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Negative Cases",
      "item": [
        {
          "name": "Init Dynamic Data (Bootstrap)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/categories/"
          },
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const isInitRequest = pm.info.requestName === 'Init Dynamic Data (Bootstrap)';",
                  "if (isInitRequest || !pm.collectionVariables.get('runId')) {",
                  "  const runId = String(Date.now());",
                  "  pm.collectionVariables.set('runId', runId);",
                  "  pm.collectionVariables.set('categoryOneName', 'Cleaning ' + runId);",
                  "  pm.collectionVariables.set('categoryTwoName', 'Plumbing ' + runId);",
                  "  pm.collectionVariables.set('serviceOneTitle', 'Home Cleaning ' + runId);",
                  "  pm.collectionVariables.set('serviceTwoTitle', 'Pipe Repair ' + runId);",
                  "  pm.collectionVariables.set('nonExistentBookingId', '00000000-0000-0000-0000-000000000000');",
                  "}"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Initialization request completed', function () {",
                  "  pm.expect([200, 500]).to.include(pm.response.code);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Provider Login",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/auth/login",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{providerEmail}}\",\n  \"password\": \"{{providerPassword}}\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const decodeJwtPayload = (token) => {",
                  "  if (!token || token.split('.').length !== 3) return null;",
                  "  const base64Url = token.split('.')[1];",
                  "  const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');",
                  "  const jsonPayload = decodeURIComponent(",
                  "    atob(base64)",
                  "      .split('')",
                  "      .map((c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))",
                  "      .join('')",
                  "  );",
                  "  return JSON.parse(jsonPayload);",
                  "};",
                  "",
                  "",
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Provider login returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "pm.expect(json && json.accessToken, 'Expected accessToken').to.be.a('string');",
                  "pm.collectionVariables.set('providerAccessToken', json.accessToken);",
                  "",
                  "const payload = decodeJwtPayload(json.accessToken);",
                  "if (payload && payload.role) pm.collectionVariables.set('providerTokenRole', payload.role);",
                  "if (payload && payload.id) pm.collectionVariables.set('providerUserId', payload.id);"
                ]
              }
            }
          ]
        },
        {
          "name": "Provider Profile Snapshot",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{providerAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/users/profile"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Provider profile returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "pm.expect(json && json.id, 'Expected provider id').to.be.a('string');",
                  "pm.collectionVariables.set('providerUserId', String(json.id));",
                  "pm.collectionVariables.set('providerUserType', String(json.user_type || ''));"
                ]
              }
            }
          ]
        },
        {
          "name": "Promote Provider If Needed",
          "request": {
            "method": "PATCH",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{providerAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/users/promote",
            "body": {
              "mode": "raw",
              "raw": "{}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const decodeJwtPayload = (token) => {",
                  "  if (!token || token.split('.').length !== 3) return null;",
                  "  const base64Url = token.split('.')[1];",
                  "  const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');",
                  "  const jsonPayload = decodeURIComponent(",
                  "    atob(base64)",
                  "      .split('')",
                  "      .map((c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))",
                  "      .join('')",
                  "  );",
                  "  return JSON.parse(jsonPayload);",
                  "};",
                  "",
                  "",
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Promote endpoint returns expected status', function () {",
                  "  pm.expect([200, 400, 403]).to.include(pm.response.code);",
                  "});",
                  "",
                  "if (pm.response.code === 200) {",
                  "  const json = parseJsonSafe();",
                  "  if (json && json.accessToken) {",
                  "    pm.collectionVariables.set('providerAccessToken', json.accessToken);",
                  "    const payload = decodeJwtPayload(json.accessToken);",
                  "    if (payload && payload.role) pm.collectionVariables.set('providerTokenRole', payload.role);",
                  "  }",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "Provider Refresh Token Role Sync",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/auth/refresh",
            "body": {
              "mode": "raw",
              "raw": "{}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const decodeJwtPayload = (token) => {",
                  "  if (!token || token.split('.').length !== 3) return null;",
                  "  const base64Url = token.split('.')[1];",
                  "  const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');",
                  "  const jsonPayload = decodeURIComponent(",
                  "    atob(base64)",
                  "      .split('')",
                  "      .map((c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))",
                  "      .join('')",
                  "  );",
                  "  return JSON.parse(jsonPayload);",
                  "};",
                  "",
                  "",
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Provider refresh returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "pm.expect(json && json.accessToken, 'Expected refreshed accessToken').to.be.a('string');",
                  "pm.collectionVariables.set('providerAccessToken', json.accessToken);",
                  "",
                  "const payload = decodeJwtPayload(json.accessToken);",
                  "pm.expect(payload && payload.role, 'Expected role claim').to.be.a('string');",
                  "pm.collectionVariables.set('providerTokenRole', payload.role);",
                  "pm.test('Refreshed provider token has provider role', function () {",
                  "  pm.expect(payload.role).to.eql('provider');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Client Login",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/auth/login",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{clientEmail}}\",\n  \"password\": \"{{clientPassword}}\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const decodeJwtPayload = (token) => {",
                  "  if (!token || token.split('.').length !== 3) return null;",
                  "  const base64Url = token.split('.')[1];",
                  "  const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');",
                  "  const jsonPayload = decodeURIComponent(",
                  "    atob(base64)",
                  "      .split('')",
                  "      .map((c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))",
                  "      .join('')",
                  "  );",
                  "  return JSON.parse(jsonPayload);",
                  "};",
                  "",
                  "",
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Client login returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "pm.expect(json && json.accessToken, 'Expected accessToken').to.be.a('string');",
                  "pm.collectionVariables.set('clientAccessToken', json.accessToken);",
                  "",
                  "const payload = decodeJwtPayload(json.accessToken);",
                  "if (payload && payload.role) pm.collectionVariables.set('clientTokenRole', payload.role);",
                  "if (payload && payload.id) pm.collectionVariables.set('clientUserId', payload.id);"
                ]
              }
            }
          ]
        },
        {
          "name": "Client Profile Snapshot",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{clientAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/users/profile"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Client profile returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "pm.expect(json && json.id, 'Expected client id').to.be.a('string');",
                  "pm.collectionVariables.set('clientUserId', String(json.id));",
                  "pm.collectionVariables.set('clientUserType', String(json.user_type || ''));"
                ]
              }
            }
          ]
        },
        {
          "name": "DB Snapshot Categories (Public)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/categories/"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "const parseJsonSafe = () => {",
                  "  const type = String(pm.response.headers.get('Content-Type') || '').toLowerCase();",
                  "  if (!type.includes('application/json')) return null;",
                  "  try {",
                  "    return pm.response.json();",
                  "  } catch (err) {",
                  "    return null;",
                  "  }",
                  "};",
                  "",
                  "const asArray = (json, key) => {",
                  "  if (Array.isArray(json)) return json;",
                  "  if (json && Array.isArray(json[key])) return json[key];",
                  "  return [];",
                  "};",
                  "",
                  "const asEntity = (json, key) => {",
                  "  if (!json || typeof json !== 'object') return null;",
                  "  if (key && json[key] && typeof json[key] === 'object' && !Array.isArray(json[key])) return json[key];",
                  "  if (json.data && typeof json.data === 'object' && !Array.isArray(json.data)) return json.data;",
                  "  if (json.result && typeof json.result === 'object' && !Array.isArray(json.result)) return json.result;",
                  "  if (json.id || json._id) return json;",
                  "  return null;",
                  "};",
                  "",
                  "const getId = (entity) => {",
                  "  if (!entity || typeof entity !== 'object') return '';",
                  "  return String(entity.id || entity._id || '');",
                  "};",
                  "",
                  "pm.test('Public categories returns 200', function () {",
                  "  pm.response.to.have.status(200);",
                  "});",
                  "",
                  "const json = parseJsonSafe();",
                  "const categories = asArray(json, 'categories');",
                  "pm.expect(categories, 'Expected categories array').to.be.an('array');",
                  "pm.collectionVariables.set('categoriesCount', String(categories.length));",
                  "",
                  "const runId = pm.collectionVariables.get('runId');",
                  "const nameOne = 'Cleaning ' + runId;",
                  "const nameTwo = 'Plumbing ' + runId;",
                  "",
                  "const existingOne = categories.find((c) => c && c.name === nameOne);",
                  "const existingTwo = categories.find((c) => c && c.name === nameTwo);",
                  "",
                  "if (!pm.collectionVariables.get('categoryOneId')) {",
                  "  if (existingOne && existingOne.id !== undefined) {",
                  "    pm.collectionVariables.set('categoryOneId', String(existingOne.id));",
                  "  } else if (categories[0] && categories[0].id !== undefined) {",
                  "    pm.collectionVariables.set('categoryOneId', String(categories[0].id));",
                  "  }",
                  "}",
                  "",
                  "if (!pm.collectionVariables.get('categoryTwoId')) {",
                  "  if (existingTwo && existingTwo.id !== undefined) {",
                  "    pm.collectionVariables.set('categoryTwoId', String(existingTwo.id));",
                  "  } else if (categories[1] && categories[1].id !== undefined) {",
                  "    pm.collectionVariables.set('categoryTwoId', String(categories[1].id));",
                  "  } else if (pm.collectionVariables.get('categoryOneId')) {",
                  "    pm.collectionVariables.set('categoryTwoId', String(pm.collectionVariables.get('categoryOneId')));",
                  "  }",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "No Token Profile Request",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/v1/users/profile"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Profile without token returns 401', function () {",
                  "  pm.response.to.have.status(401);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Client Tries To Create Service",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{clientAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/services/create",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"category_id\": \"{{categoryOneId}}\",\n  \"title\": \"Forbidden Service Attempt\",\n  \"description\": \"Should fail by role check\",\n  \"price\": 900,\n  \"service_type\": \"onsite\",\n  \"location\": \"Makati\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Client cannot create service', function () {",
                  "  pm.response.to.have.status(403);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Client Change Role Forbidden",
          "request": {
            "method": "PATCH",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{clientAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/users/{{providerUserId}}/role",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"user_type\": \"admin\"\n}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Client cannot change roles', function () {",
                  "  pm.response.to.have.status(403);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Update Booking Status Missing Body",
          "request": {
            "method": "PATCH",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{clientAccessToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/v1/bookings/{{nonExistentBookingId}}/status",
            "body": {
              "mode": "raw",
              "raw": "{}",
              "options": {
                "raw": {
                  "language": "json"
                }
              }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Missing status returns 400', function () {",
                  "  pm.response.to.have.status(400);",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    }
  ],
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "const isInitRequest = pm.info.requestName === 'Init Dynamic Data (Bootstrap)';",
          "if (isInitRequest || !pm.collectionVariables.get('runId')) {",
          "  const runId = String(Date.now());",
          "  pm.collectionVariables.set('runId', runId);",
          "  pm.collectionVariables.set('categoryOneName', 'Cleaning ' + runId);",
          "  pm.collectionVariables.set('categoryTwoName', 'Plumbing ' + runId);",
          "  pm.collectionVariables.set('serviceOneTitle', 'Home Cleaning ' + runId);",
          "  pm.collectionVariables.set('serviceTwoTitle', 'Pipe Repair ' + runId);",
          "  pm.collectionVariables.set('nonExistentBookingId', '00000000-0000-0000-0000-000000000000');",
          "}"
        ]
      }
    }
  ],
  "variable": [
    {
      "key": "runId",
      "value": ""
    },
    {
      "key": "adminAccessToken",
      "value": ""
    },
    {
      "key": "providerAccessToken",
      "value": ""
    },
    {
      "key": "clientAccessToken",
      "value": ""
    },
    {
      "key": "adminUserId",
      "value": ""
    },
    {
      "key": "providerUserId",
      "value": ""
    },
    {
      "key": "clientUserId",
      "value": ""
    },
    {
      "key": "providerTokenRole",
      "value": ""
    },
    {
      "key": "clientTokenRole",
      "value": ""
    },
    {
      "key": "providerUserType",
      "value": ""
    },
    {
      "key": "clientUserType",
      "value": ""
    },
    {
      "key": "categoryOneId",
      "value": ""
    },
    {
      "key": "categoryTwoId",
      "value": ""
    },
    {
      "key": "serviceId",
      "value": ""
    },
    {
      "key": "serviceTwoId",
      "value": ""
    },
    {
      "key": "bookingId",
      "value": ""
    },
    {
      "key": "usersCount",
      "value": ""
    },
    {
      "key": "categoriesCount",
      "value": ""
    },
    {
      "key": "servicesCount",
      "value": ""
    },
    {
      "key": "allBookingsCount",
      "value": ""
    },
    {
      "key": "clientBookingsCount",
      "value": ""
    }
  ]
}
