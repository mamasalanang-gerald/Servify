name: CI - Build and Test

on:
  pull_request:
    branches: ["main"]
    types: [opened, synchronize, reopened]

env:
  REGISTRY: ${{ secrets.DOCKER_USERNAME }}
  BACKEND_IMAGE: servify-backend
  FRONTEND_IMAGE: servify-frontend

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PHASE 1: LINT & VALIDATE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  phase-1-lint-validate:
    name: Phase 1 - Lint & Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Check for merge conflicts
        run: |
          echo "Checking for merge conflict markers..."
          if grep -r "<<<<<<< HEAD" . --exclude-dir=node_modules --exclude-dir=.git; then
            echo "âŒ Merge conflict markers found!"
            exit 1
          fi
          echo "âœ… No merge conflicts detected"

      - name: ğŸ“‹ Validate Dockerfiles exist
        run: |
          echo "âœ… Validating frontend Dockerfile..."
          if [ ! -f client/Dockerfile ]; then
            echo "âŒ client/Dockerfile not found!"
            exit 1
          fi
          
          echo "âœ… Validating backend Dockerfile..."
          if [ ! -f server/Dockerfile ]; then
            echo "âŒ server/Dockerfile not found!"
            exit 1
          fi
          
          echo "âœ… Both Dockerfiles found"

      - name: ğŸ“¦ Validate docker-compose.yml exists
        run: |
          if [ ! -f docker-compose.yml ]; then
            echo "âŒ docker-compose.yml not found!"
            exit 1
          fi
          echo "âœ… docker-compose.yml found"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PHASE 2/LAYER 1: UNIT TESTS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  layer-1-frontend-unit-tests:
    name: "Layer 1 - Frontend Unit Tests"
    needs: phase-1-lint-validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'client/package-lock.json'

      - name: Install frontend dependencies
        working-directory: ./client
        run: npm ci

      - name: Run frontend unit tests
        working-directory: ./client
        run: npm run test:unit || echo "âš ï¸ No unit tests configured yet"

      - name: Run frontend linter
        working-directory: ./client
        run: npm run lint || echo "âš ï¸ ESLint not configured yet"

  layer-1-backend-unit-tests:
    name: "Layer 1 - Backend Unit Tests"
    needs: phase-1-lint-validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'server/package-lock.json'

      - name: Install backend dependencies
        working-directory: ./server
        run: npm ci

      - name: Run backend unit tests
        working-directory: ./server
        run: npm run test:unit || echo "âš ï¸ No unit tests configured yet"

      - name: Run backend linter
        working-directory: ./server
        run: npm run lint || echo "âš ï¸ Linter not configured yet"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PHASE 3/LAYER 2: INTEGRATION TESTS (runs in parallel with Layer 1)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  layer-2-backend-integration-tests:
    name: "Layer 2 - Backend Integration Tests"
    needs: phase-1-lint-validate
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'server/package-lock.json'

      - name: Install backend dependencies
        working-directory: ./server
        run: npm ci

      - name: Run backend integration tests (with database)
        working-directory: ./server
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: test_db
          DB_USERNAME: test_user
          DB_PASSWORD: test_pass
        run: npm run test:integration || echo "âš ï¸ No integration tests configured yet"

  layer-2-frontend-backend-integration:
    name: "Layer 2 - Frontend-Backend Integration Tests"
    needs: [layer-1-frontend-unit-tests, layer-1-backend-unit-tests]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd client && npm ci
          cd ../server && npm ci

      - name: Start backend server (background)
        working-directory: ./server
        run: |
          npm start &
          sleep 3
          echo "Backend server started"

      - name: Run frontend-backend integration tests
        working-directory: ./client
        run: npm run test:integration || echo "âš ï¸ No integration tests configured yet"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PHASE 4/LAYER 3: END-TO-END TESTS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  layer-3-e2e-tests:
    name: "Layer 3 - E2E Tests (Playwright)"
    needs: [layer-2-backend-integration-tests, layer-2-frontend-backend-integration]
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install client dependencies
        working-directory: ./client
        run: npm ci

      - name: Install server dependencies
        working-directory: ./server
        run: npm ci

      - name: Install Playwright browsers
        working-directory: ./client
        run: npx playwright install --with-deps || echo "âš ï¸ Playwright not configured yet"

      - name: Start backend server
        working-directory: ./server
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: test_db
          DB_USERNAME: test_user
          DB_PASSWORD: test_pass
          PORT: 3000
        run: |
          npm start &
          sleep 3
          echo "Backend started"

      - name: Start frontend dev server
        working-directory: ./client
        run: |
          npm run dev &
          sleep 5
          echo "Frontend started"

      - name: Wait for services to be ready
        run: |
          echo "Waiting for services..."
          max_retries=30
          retry_count=0
          while [ $retry_count -lt $max_retries ]; do
            if curl -s http://localhost:5173 > /dev/null && curl -s http://localhost:3000 > /dev/null; then
              echo "âœ… Services ready!"
              exit 0
            fi
            echo "Attempt $((retry_count + 1))/$max_retries..."
            sleep 2
            retry_count=$((retry_count + 1))
          done
          echo "âš ï¸ Services may not be fully ready, continuing anyway"

      - name: Run E2E tests
        working-directory: ./client
        timeout-minutes: 10
        run: npx playwright test || echo "âš ï¸ E2E tests not configured yet"

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: client/playwright-report/
          retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PHASE 5: DOCKER BUILD & TEST
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  phase-5-docker-build-test:
    name: "Phase 5 - Docker Build & Test"
    needs: layer-3-e2e-tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”¨ Build backend Docker image
        run: |
          echo "Building backend Docker image..."
          docker build -f server/Dockerfile \
            -t $REGISTRY/$BACKEND_IMAGE:test \
            ./server
          echo "âœ… Backend image built successfully!"

      - name: ğŸ”¨ Build frontend Docker image
        run: |
          echo "Building frontend Docker image..."
          docker build -f client/Dockerfile \
            -t $REGISTRY/$FRONTEND_IMAGE:test \
            ./client
          echo "âœ… Frontend image built successfully!"

      - name: ğŸ§ª Test backend container startup
        run: |
          echo "Testing backend container..."
          docker run -d --name test-backend \
            -p 3000:3000 \
            -e DB_HOST="postgres" \
            -e DB_PORT="5432" \
            -e DB_NAME="test_db" \
            -e DB_USERNAME="test_user" \
            -e DB_PASSWORD="test_pass" \
            -e PORT="3000" \
            $REGISTRY/$BACKEND_IMAGE:test
          
          sleep 5
          if docker ps | grep -q test-backend; then
            echo "âœ… Backend container started successfully!"
            docker logs test-backend | head -20
            docker stop test-backend
            docker rm test-backend
          else
            echo "âŒ Backend container failed to start!"
            docker logs test-backend || true
            exit 1
          fi

      - name: ğŸ§ª Test frontend container startup
        run: |
          echo "Testing frontend container..."
          docker run -d --name test-frontend -p 5173:5173 $REGISTRY/$FRONTEND_IMAGE:test
          sleep 5
          if docker ps | grep -q test-frontend; then
            echo "âœ… Frontend container started successfully!"
            docker logs test-frontend | head -20
            docker stop test-frontend
            docker rm test-frontend
          else
            echo "âŒ Frontend container failed to start!"
            docker logs test-frontend || true
            exit 1
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PHASE 6: CI SUMMARY & REPORTING
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  phase-6-ci-summary:
    name: "Phase 6 - CI Summary"
    needs: [phase-1-lint-validate, layer-1-frontend-unit-tests, layer-1-backend-unit-tests, 
            layer-2-backend-integration-tests, layer-2-frontend-backend-integration, 
            layer-3-e2e-tests, phase-5-docker-build-test]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine CI Status
        id: status
        run: |
          if [ "${{ needs.phase-1-lint-validate.result }}" = "failure" ] || \
             [ "${{ needs.layer-1-frontend-unit-tests.result }}" = "failure" ] || \
             [ "${{ needs.layer-1-backend-unit-tests.result }}" = "failure" ] || \
             [ "${{ needs.layer-2-backend-integration-tests.result }}" = "failure" ] || \
             [ "${{ needs.layer-2-frontend-backend-integration.result }}" = "failure" ] || \
             [ "${{ needs.layer-3-e2e-tests.result }}" = "failure" ] || \
             [ "${{ needs.phase-5-docker-build-test.result }}" = "failure" ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
          fi

      - name: âœ… CI Passed - All Phases Complete
        if: steps.status.outputs.status == 'success'
        run: |
          cat << 'EOF'
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          âœ… CI PIPELINE PASSED - ALL PHASES SUCCESSFUL
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ“‹ CI Pipeline Summary:
          
          âœ… PHASE 1: Lint & Validate
             â”œâ”€ Merge conflicts check
             â”œâ”€ Dockerfiles validation
             â””â”€ docker-compose.yml validation
          
          âœ… LAYER 1: Unit Tests (Parallel)
             â”œâ”€ Frontend unit tests
             â””â”€ Backend unit tests
          
          âœ… LAYER 2: Integration Tests (Parallel)
             â”œâ”€ Backend + Database integration
             â””â”€ Frontend + Backend integration
          
          âœ… LAYER 3: E2E Tests
             â””â”€ End-to-End testing with Playwright
          
          âœ… PHASE 5: Docker Build & Test
             â”œâ”€ Backend image build & test
             â””â”€ Frontend image build & test
          
          ğŸ‰ All checks passed! PR is ready to merge.
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          EOF

      - name: âŒ CI Failed - Phase Breakdown
        if: steps.status.outputs.status == 'failure'
        id: error_report
        run: |
          {
            echo 'error_report<<EOF'
            echo '## âŒ CI Pipeline Failed - Phase Breakdown'
            echo ''
            echo '**PR Details:**'
            echo "- Run: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            if [ -n "${{ github.event.pull_request.number }}" ]; then
              echo "- PR: #${{ github.event.pull_request.number }}"
              echo "- Branch: \`${{ github.head_ref }}\`"
            fi
            echo "- Commit: \`${{ github.sha }}\`"
            echo ''
            echo '### Failed Phases:'
            echo ''
            
            if [ "${{ needs.phase-1-lint-validate.result }}" = "failure" ]; then
              echo 'âŒ **PHASE 1: Lint & Validate**'
              echo '   - Check for merge conflict markers'
              echo '   - Verify client/Dockerfile exists'
              echo '   - Verify server/Dockerfile exists'
              echo '   - Verify docker-compose.yml exists'
              echo ''
            fi
            
            if [ "${{ needs.layer-1-frontend-unit-tests.result }}" = "failure" ]; then
              echo 'âŒ **LAYER 1: Frontend Unit Tests**'
              echo '   - Frontend dependencies installation failed'
              echo '   - Linting errors detected'
              echo '   - Run locally: \`cd client && npm ci && npm run lint\`'
              echo ''
            fi
            
            if [ "${{ needs.layer-1-backend-unit-tests.result }}" = "failure" ]; then
              echo 'âŒ **LAYER 1: Backend Unit Tests**'
              echo '   - Backend dependencies installation failed'
              echo '   - Linting errors detected'
              echo '   - Run locally: \`cd server && npm ci && npm run lint\`'
              echo ''
            fi
            
            if [ "${{ needs.layer-2-backend-integration-tests.result }}" = "failure" ]; then
              echo 'âŒ **LAYER 2: Backend Integration Tests**'
              echo '   - Database connectivity issues'
              echo '   - Integration test failures'
              echo '   - Check database setup'
              echo ''
            fi
            
            if [ "${{ needs.layer-2-frontend-backend-integration.result }}" = "failure" ]; then
              echo 'âŒ **LAYER 2: Frontend-Backend Integration**'
              echo '   - Frontend cannot connect to backend'
              echo '   - API response validation failed'
              echo '   - Check API endpoints'
              echo ''
            fi
            
            if [ "${{ needs.layer-3-e2e-tests.result }}" = "failure" ]; then
              echo 'âŒ **LAYER 3: E2E Tests**'
              echo '   - End-to-end test scenarios failed'
              echo '   - User workflow validation issues'
              echo '   - Run locally: \`cd client && npx playwright test\`'
              echo ''
            fi
            
            if [ "${{ needs.phase-5-docker-build-test.result }}" = "failure" ]; then
              echo 'âŒ **PHASE 5: Docker Build & Test**'
              echo '   - Docker image build failed'
              echo '   - Container startup issues'
              echo '   - Check Dockerfiles and dependencies'
              echo ''
            fi
            
            echo '### Required Actions:'
            echo ''
            echo '1. Review the logs by clicking the workflow run link'
            echo '2. Identify which phase failed'
            echo '3. Fix issues locally and test'
            echo '4. Push fixes to update the PR'
            echo '5. CI will automatically re-run'
            echo ''
            echo '### Quick Troubleshooting:'
            echo ''
            echo '**Phase 1 Failed?**'
            echo '- Resolve merge conflicts in your branch'
            echo '- Ensure Dockerfiles exist: \`ls -la client/Dockerfile server/Dockerfile\`'
            echo '- Verify YAML: \`docker-compose config\`'
            echo ''
            echo '**Layer 1 Failed?**'
            echo '- \`cd client && npm ci && npm run lint\`'
            echo '- \`cd server && npm ci && npm run lint\`'
            echo ''
            echo '**Layer 2 Failed?**'
            echo '- Ensure PostgreSQL is running'
            echo '- Check database connection strings'
            echo ''
            echo '**Layer 3 Failed?**'
            echo '- Verify frontend and backend are accessible'
            echo '- Check Playwright configuration'
            echo ''
            echo '**Phase 5 Failed?**'
            echo '- \`docker build -f client/Dockerfile ./client\`'
            echo '- \`docker build -f server/Dockerfile ./server\`'
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Post Result to PR
        if: github.event_name == 'pull_request'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.status.outputs.status }}';
            const errorReport = '${{ steps.error_report.outputs.error_report }}';
            
            let body = '';
            if (status === 'success') {
              body = `âœ… **CI Pipeline Passed!**\n\nğŸ‰ All 6 phases completed successfully:\n\nâœ… Phase 1: Lint & Validate\nâœ… Layer 1: Unit Tests\nâœ… Layer 2: Integration Tests\nâœ… Layer 3: E2E Tests\nâœ… Phase 5: Docker Build & Test\n\nThis PR is ready to merge!`;
            } else {
              body = errorReport || 'âŒ **CI Pipeline Failed**\n\nPlease check the workflow logs for details.';
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Fail workflow if CI failed
        if: steps.status.outputs.status == 'failure'
        run: |
          echo "âŒ CI pipeline failed - see phase breakdown above"
          exit 1
