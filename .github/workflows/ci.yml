name: CI - Build and Test

on:
  pull_request:
    branches: ["main", "develop"]
    types: [opened, synchronize, reopened]
  push:
    branches: ["main"]

env:
  REGISTRY: ${{ secrets.DOCKER_USERNAME }}
  BACKEND_IMAGE: servify-backend
  FRONTEND_IMAGE: servify-frontend

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  # STAGE 1: Lint and Validate
  lint-and-validate:
    name: Lint and Validate Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Dockerfiles
        run: |
          echo "âœ… Validating frontend Dockerfile..."
          if [ -f client/Dockerfile ]; then
            echo "Frontend Dockerfile found"
          else
            echo "âŒ Frontend Dockerfile not found!"
            exit 1
          fi
          
          echo "âœ… Validating backend Dockerfile..."
          if [ -f server/Dockerfile ]; then
            echo "Backend Dockerfile found"
          else
            echo "âŒ Backend Dockerfile not found!"
            exit 1
          fi

      - name: Validate docker-compose.yml
        run: |
          if [ -f docker-compose.yml ]; then
            echo "âœ… docker-compose.yml found"
          else
            echo "âŒ docker-compose.yml not found!"
            exit 1
          fi

      - name: Check for merge conflicts
        run: |
          if git diff --check; then
            echo "âœ… No merge conflicts detected"
          else
            echo "âŒ Merge conflicts detected!"
            exit 1
          fi

  # STAGE 2: Frontend - Lint & Unit Tests
  frontend-tests:
    name: Frontend - Lint & Unit Tests
    needs: lint-and-validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'client/package-lock.json'

      - name: Install frontend dependencies
        working-directory: ./client
        run: npm ci

      - name: Run frontend linter
        working-directory: ./client
        run: npm run lint

  # STAGE 3: Backend - Lint & Unit Tests
  backend-tests:
    name: Backend - Lint & Unit Tests
    needs: lint-and-validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'server/package-lock.json'

      - name: Install backend dependencies
        working-directory: ./server
        run: npm ci

      - name: Check for syntax errors
        working-directory: ./server
        run: npm run lint || echo "No linter configured, skipping"

  # STAGE 4: Docker Build & Test
  docker-build-test:
    name: Build and Test Docker Images
    needs: [frontend-tests, backend-tests]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build frontend image
        run: |
          echo "ğŸ”¨ Building frontend Docker image..."
          docker build -f client/Dockerfile \
            -t $REGISTRY/$FRONTEND_IMAGE:test \
            ./client
          echo "âœ… Frontend image built successfully!"

      - name: Build backend image
        run: |
          echo "ğŸ”¨ Building backend Docker image..."
          docker build -f server/Dockerfile \
            -t $REGISTRY/$BACKEND_IMAGE:test \
            ./server
          echo "âœ… Backend image built successfully!"

      - name: Test backend container startup
        run: |
          echo "ğŸ§ª Testing backend container..."
          docker run -d --name test-backend \
            -p 3000:3000 \
            -e DB_HOST="postgres" \
            -e DB_PORT="5432" \
            -e DB_NAME="test_db" \
            -e DB_USERNAME="test_user" \
            -e DB_PASSWORD="test_pass" \
            -e PORT="3000" \
            $REGISTRY/$BACKEND_IMAGE:test
          
          sleep 5
          if docker ps | grep -q test-backend; then
            echo "âœ… Backend container started successfully!"
            docker logs test-backend
            docker stop test-backend
            docker rm test-backend
          else
            echo "âŒ Backend container failed to start!"
            docker logs test-backend || true
            exit 1
          fi

      - name: Test frontend container startup
        run: |
          echo "ğŸ§ª Testing frontend container..."
          docker run -d --name test-frontend -p 5173:5173 $REGISTRY/$FRONTEND_IMAGE:test
          sleep 5
          if docker ps | grep -q test-frontend; then
            echo "âœ… Frontend container started successfully!"
            docker logs test-frontend
            docker stop test-frontend
            docker rm test-frontend
          else
            echo "âŒ Frontend container failed to start!"
            docker logs test-frontend || true
            exit 1
          fi

  # STAGE 5: Security Scanning (Optional but Recommended)
  security-scan:
    name: Security Scanning & SBOM
    needs: docker-build-test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: secrets.DOCKER_USERNAME != ''
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push backend image
        run: |
          docker build -f server/Dockerfile \
            -t $REGISTRY/$BACKEND_IMAGE:pr-${{ github.event.pull_request.number }} \
            ./server
          [ -z "$REGISTRY" ] || docker push $REGISTRY/$BACKEND_IMAGE:pr-${{ github.event.pull_request.number }} || true

      - name: Build and push frontend image
        run: |
          docker build -f client/Dockerfile \
            -t $REGISTRY/$FRONTEND_IMAGE:pr-${{ github.event.pull_request.number }} \
            ./client
          [ -z "$REGISTRY" ] || docker push $REGISTRY/$FRONTEND_IMAGE:pr-${{ github.event.pull_request.number }} || true

      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      - name: Scan backend image with Trivy
        run: |
          trivy image --format table --severity CRITICAL,HIGH \
            $REGISTRY/$BACKEND_IMAGE:pr-${{ github.event.pull_request.number }} || true

      - name: Scan frontend image with Trivy
        run: |
          trivy image --format table --severity CRITICAL,HIGH \
            $REGISTRY/$FRONTEND_IMAGE:pr-${{ github.event.pull_request.number }} || true

  # STAGE 6: CI Summary
  ci-summary:
    name: CI Summary
    needs: [lint-and-validate, frontend-tests, backend-tests, docker-build-test, security-scan]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine CI Status
        id: status
        run: |
          if [ "${{ needs.lint-and-validate.result }}" = "failure" ] || \
             [ "${{ needs.frontend-tests.result }}" = "failure" ] || \
             [ "${{ needs.backend-tests.result }}" = "failure" ] || \
             [ "${{ needs.docker-build-test.result }}" = "failure" ] || \
             [ "${{ needs.security-scan.result }}" = "failure" ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
          fi

      - name: CI Passed
        if: steps.status.outputs.status == 'success'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… All CI checks passed!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“‹ Summary:"
          echo "  âœ… Linting and validation - Passed"
          echo "  âœ… Frontend tests (linting) - Passed"
          echo "  âœ… Backend tests (linting) - Passed"
          echo "  âœ… Docker image builds - Passed"
          echo "  âœ… Container startup tests - Passed"
          echo "  âœ… Security scanning - Passed"
          echo ""
          echo "ğŸ‰ This PR is ready to be merged!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: CI Failed - Generate Error Report
        if: steps.status.outputs.status == 'failure'
        id: error_report
        run: |
          {
            echo 'error_report<<EOF'
            echo '## âŒ CI Pipeline Failed'
            echo ''
            echo '**Build Details:**'
            echo "- Run: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            if [ -n "${{ github.event.pull_request.number }}" ]; then
              echo "- PR: #${{ github.event.pull_request.number }}"
              echo "- Branch: \`${{ github.head_ref }}\`"
            fi
            echo "- Commit: \`${{ github.sha }}\`"
            echo ''
            echo '### Failed Jobs:'
            echo ''
            
            if [ "${{ needs.lint-and-validate.result }}" = "failure" ]; then
              echo 'âŒ **Lint and Validate** - Check Dockerfile and docker-compose.yml'
              echo ''
            fi
            
            if [ "${{ needs.frontend-tests.result }}" = "failure" ]; then
              echo 'âŒ **Frontend Tests** - Run \`cd client && npm run lint\` locally'
              echo ''
            fi
            
            if [ "${{ needs.backend-tests.result }}" = "failure" ]; then
              echo 'âŒ **Backend Tests** - Run \`cd server && npm install\` locally'
              echo ''
            fi
            
            if [ "${{ needs.docker-build-test.result }}" = "failure" ]; then
              echo 'âŒ **Docker Build & Test** - Check Dockerfiles and dependencies'
              echo ''
            fi
            
            if [ "${{ needs.security-scan.result }}" = "failure" ]; then
              echo 'âŒ **Security Scanning** - Review Trivy scan results'
              echo ''
            fi
            
            echo '### Action Required:'
            echo ''
            echo '1. **Review the full logs** by clicking the workflow run link'
            echo '2. **Identify the root cause** from the error messages'
            echo '3. **Fix the issues** in your feature branch'
            echo '4. **Push fixes** to update the PR'
            echo '5. **CI will automatically re-run** on new commits'
            echo ''
            echo '### Troubleshooting:'
            echo ''
            echo '**Frontend Tests Failed?**'
            echo '- \`cd client && npm install\`'
            echo '- \`npm run lint\`'
            echo ''
            echo '**Backend Tests Failed?**'
            echo '- \`cd server && npm install\`'
            echo ''
            echo '**Docker Build Failed?**'
            echo '- Verify Dockerfiles exist and are valid'
            echo '- Check package.json for missing dependencies'
            echo ''
            echo '**Container Startup Failed?**'
            echo '- Check environment variables'
            echo '- Review container logs'
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Post CI Result to PR
        if: github.event_name == 'pull_request'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.status.outputs.status }}';
            const errorReport = '${{ steps.error_report.outputs.error_report }}';
            
            let body = '';
            if (status === 'success') {
              body = 'âœ… **CI Pipeline Passed!**\n\nAll checks have passed. This PR is ready to be merged.';
            } else {
              body = errorReport || 'âŒ **CI Pipeline Failed**\n\nPlease check the workflow logs for details.';
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Fail workflow on CI failure
        if: steps.status.outputs.status == 'failure'
        run: |
          echo "âŒ CI pipeline failed. Check the logs and error report for details."
          exit 1
