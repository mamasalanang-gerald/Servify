name: CI - Build and Test

on:
  pull_request:
    branches: ["main", "develop"]
    types: [opened, synchronize, reopened]
  push:
    branches: ["main"]

env:
  REGISTRY: ${{ secrets.DOCKER_USERNAME }}
  BACKEND_IMAGE: servify-backend
  FRONTEND_IMAGE: servify-frontend

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PHASE 1: LINT & VALIDATE (~30s)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  phase-1-lint-validate:
    name: "Phase 1: Lint & Validate"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Check for merge conflicts
        run: |
          echo "Checking for merge conflict markers..."
          if grep -r "<<<<<<< HEAD" . --exclude-dir=node_modules --exclude-dir=.git; then
            echo "âŒ Merge conflict markers found!"
            exit 1
          fi
          echo "âœ… No merge conflicts detected"

      - name: ğŸ“‹ Validate Dockerfiles exist
        run: |
          echo "Validating frontend Dockerfile..."
          if [ ! -f client/Dockerfile ]; then
            echo "âŒ client/Dockerfile not found!"
            exit 1
          fi
          
          echo "Validating backend Dockerfile..."
          if [ ! -f server/Dockerfile ]; then
            echo "âŒ server/Dockerfile not found!"
            exit 1
          fi
          
          echo "âœ… Both Dockerfiles found"

      - name: ğŸ“¦ Validate docker-compose.yml
        run: |
          if [ ! -f docker-compose.yml ]; then
            echo "âŒ docker-compose.yml not found!"
            exit 1
          fi
          echo "âœ… docker-compose.yml found"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PHASE 2: FRONTEND TESTS (~60s)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  phase-2-frontend-tests:
    name: "Phase 2: Frontend Tests"
    needs: phase-1-lint-validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'client/package-lock.json'

      - name: ğŸ“¦ Install dependencies
        working-directory: ./client
        run: npm ci

      - name: ğŸ” Run ESLint
        working-directory: ./client
        run: npm run lint

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PHASE 3: BACKEND TESTS (~30s)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  phase-3-backend-tests:
    name: "Phase 3: Backend Tests"
    needs: phase-1-lint-validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'server/package-lock.json'

      - name: ğŸ“¦ Install dependencies
        working-directory: ./server
        run: npm ci

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PHASE 4: DOCKER BUILD & TEST (~2 min)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  phase-4-docker-build-test:
    name: "Phase 4: Docker Build & Test"
    needs: [phase-2-frontend-tests, phase-3-backend-tests]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”¨ Build backend Docker image
        run: |
          echo "Building backend Docker image..."
          docker build -f server/Dockerfile -t servify-backend:test ./server
          echo "âœ… Backend image built"

      - name: ğŸ”¨ Build frontend Docker image
        run: |
          echo "Building frontend Docker image..."
          docker build -f client/Dockerfile -t servify-frontend:test ./client
          echo "âœ… Frontend image built"

      - name: ğŸ§ª Test backend container startup
        run: |
          echo "Testing backend container startup..."
          docker run -d --name test-backend -p 3000:3000 servify-backend:test
          sleep 3
          if docker ps | grep -q test-backend; then
            echo "âœ… Backend container started successfully"
            docker stop test-backend
          else
            echo "âŒ Backend container failed"
            exit 1
          fi

      - name: ğŸ§ª Test frontend container startup
        run: |
          echo "Testing frontend container startup..."
          docker run -d --name test-frontend -p 5173:5173 servify-frontend:test
          sleep 3
          if docker ps | grep -q test-frontend; then
            echo "âœ… Frontend container started successfully"
            docker stop test-frontend
          else
            echo "âŒ Frontend container failed"
            exit 1
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PHASE 5: CI SUMMARY (~10s)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  phase-5-ci-summary:
    name: "Phase 5: CI Summary"
    needs: [phase-1-lint-validate, phase-2-frontend-tests, phase-3-backend-tests, phase-4-docker-build-test]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine CI Status
        id: status
        run: |
          if [ "${{ needs.phase-1-lint-validate.result }}" = "failure" ] || \
             [ "${{ needs.phase-2-frontend-tests.result }}" = "failure" ] || \
             [ "${{ needs.phase-3-backend-tests.result }}" = "failure" ] || \
             [ "${{ needs.phase-4-docker-build-test.result }}" = "failure" ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
          fi

      - name: âœ… CI Passed
        if: steps.status.outputs.status == 'success'
        run: |
          cat << 'EOF'
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          âœ… CI PIPELINE PASSED
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          âœ… Phase 1: Lint & Validate
          âœ… Phase 2: Frontend Tests
          âœ… Phase 3: Backend Tests
          âœ… Phase 4: Docker Build & Test
          
          ğŸ‰ All checks passed! Ready to merge.
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          EOF

      - name: âŒ CI Failed
        if: steps.status.outputs.status == 'failure'
        run: |
          echo "âŒ CI pipeline failed"
          exit 1

      - name: ğŸ’¬ Post Comment on PR
        if: github.event_name == 'pull_request'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.status.outputs.status }}';
            const body = status === 'success'
              ? 'âœ… **CI Pipeline Passed!** All checks completed successfully. Ready to merge.'
              : 'âŒ **CI Pipeline Failed** - Check the workflow logs for details.';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
